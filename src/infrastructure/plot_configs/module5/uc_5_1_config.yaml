# ============================================================================
# UC-5.1: Sample - Compound Class Interaction Strength
# ============================================================================
# Description: Chord diagram showing sample-compound class interactions
# Module: module5
# Plot Type: Chord Diagram (Aggregation Mode)
# Rendering: On-demand (accordion activation)
# ============================================================================

# ============================================================================
# SECTION 1: Metadata (REQUIRED)
# ============================================================================
metadata:
  use_case_id: "UC-5.1"
  module: "module5"
  title: "Sample - Compound Class Interaction Strength"
  description: >
    Visualizes the interaction strength between microbial samples and
    chemical compound classes using a chord diagram. The connections
    represent the number of interactions between each sample and each
    compound class, revealing metabolic specializations and generalist
    capabilities across the dataset.
  version: "1.0.0"
  author: "BioRemPP Development Team"
  created_date: "2025-12-02"
  tags:
    - "chord_diagram"
    - "sample_compound"
    - "interaction_network"
    - "metabolic_specialization"
    - "biorempp"
  plot_type: "chord_diagram"
  scientific_context:
    domain: "Metabolomics and Microbial Ecology"
    application: "Identifying metabolic specializations and sample-compound associations"
    interpretation: "Thicker chords indicate stronger associations; arc size represents total connections per node"

# ============================================================================
# SECTION 2: Data Configuration (REQUIRED)
# ============================================================================
data:
  source: "biorempp-result-store"
  source_type: "store"
  
  required_columns:
    - "sample"
    - "compoundclass"
  
  processing:
    steps:
      - name: "validate"
        enabled: true
        validator: "standard"
        description: "Validate required columns exist"

# ============================================================================
# SECTION 3: Visualization Configuration (REQUIRED)
# ============================================================================
visualization:
  strategy: "ChordStrategy"
  
  plotly:
    # Processing mode
    mode: "aggregation"
    source_column: "sample"
    target_column: "compoundclass"
    
    # Filter configuration
    min_link_value: 1
    
    # Color configuration
    colorscale: "Set2"
    
    # Circle arcs configuration
    circle_arcs:
      enabled: true
      width: 18
      gap: 0.03
      radius: 1.0
      proportional: true
    
    # Labels configuration
    labels:
      enabled: true
      radius_offset: 1.2
      font:
        size: 11
        family: "Arial, sans-serif"
        color: "#2c3e50"
    
    # Chords configuration
    chords:
      anchor: "arc_midpoint"
    
    # Chart configuration
    chart:
      title:
        show: true
        text: "Sample - Compound Class Interaction Network"
        font:
          size: 18
          family: "Arial, sans-serif"
          color: "#2c3e50"
    
    # Layout configuration
    layout:
      height: 900
      autosize: true
      template: "simple_white"
      margin:
        l: 80
        r: 80
        t: 100
        b: 80

# ============================================================================
# SECTION 4: Interactivity Configuration (REQUIRED)
# ============================================================================
interactivity:
  triggers:
    - component_id: "uc-5-1-accordion-group"
      property: "active_item"
      trigger_type: "accordion_activation"
      description: "Render chord diagram when accordion opens"
  
  outputs:
    - component_id: "uc-5-1-chart"
      property: "children"
      output_type: "dcc.Graph"
      description: "Sample-compound class chord diagram"
  
  states:
    - component_id: "merged-result-store"
      property: "data"
      description: "Merged data from all databases"

# ============================================================================
# SECTION 5: Validation Configuration (REQUIRED)
# ============================================================================
validation:
  rules:
    - rule: "not_empty"
      message: "Input data cannot be empty"
    
    - rule: "required_columns"
      columns: ["sample", "compoundclass"]
      message: "Data must contain 'sample' and 'compoundclass' columns"
    
    - rule: "minimum_nodes"
      min_count: 2
      message: "At least 2 nodes required for chord diagram"
    
    - rule: "minimum_links"
      min_count: 1
      message: "At least 1 connection required for chord diagram"

# ============================================================================
# SECTION 6: Performance Configuration (REQUIRED)
# ============================================================================
performance:
  cache:
    enabled: true
    layers:
      - layer: "dataframe"
        ttl: 7200
        key_template: "uc_5_1_df_{data_hash}"
        description: "Cache sample-compound aggregation"
      
      - layer: "graph"
        ttl: 3600
        key_template: "uc_5_1_chord_{data_hash}"
        description: "Cache generated chord diagram"
    
    invalidation:
      on_data_change: true
      on_config_change: true
  
  logging:
    enabled: true
    level: "INFO"
    log_cache_hits: true
    log_generation_time: true
  
  lazy_loading:
    enabled: true
    render_on_accordion: true

# ============================================================================
# SECTION 7: Error Handling (RECOMMENDED)
# ============================================================================
error_handling:
  validation_errors:
    missing_columns:
      action: "display_message"
      message: "Required columns missing: {columns}. Chord diagram requires 'sample' and 'compoundclass' columns."
    
    empty_dataframe:
      action: "display_placeholder"
      message: "No sample-compound data available. Please check BioRemPP dataset."
    
    insufficient_nodes:
      action: "display_message"
      message: "At least 2 nodes required for chord diagram. Found: {count}"
    
    no_links:
      action: "display_placeholder"
      message: "No connections found between samples and compound classes."
    
    biorempp_data_missing:
      action: "display_message"
      message: "BioRemPP database data not found. This use case requires BioRemPP data."
  
  processing_errors:
    aggregation_failure:
      action: "log_and_notify"
      fallback: "display_error_message"
      message: "Failed to aggregate sample-compound interactions: {error_details}"
    
    plot_render_failure:
      action: "log_and_notify"
      fallback: "display_error_message"
      message: "Failed to render chord diagram: {error_details}"

# ============================================================================
# NOTES: Flexible Properties & Data Flow
# ============================================================================
# Flexible Properties (Configurable via YAML):
# - circle_arcs.enabled: true/false (toggle circle arcs)
# - circle_arcs.width: Arc thickness (5-30)
# - circle_arcs.gap: Space between arcs in radians (0.01-0.1)
# - circle_arcs.radius: Circle radius (0.8-1.2)
# - circle_arcs.proportional: true/false (size based on connections)
# - labels.enabled: true/false (toggle labels)
# - labels.radius_offset: Label distance from center (1.1-1.3)
# - labels.font: Font configuration
# - chords.anchor: "arc_midpoint" or "arc_start"
# - colorscale: "Set2", "Category20", "Pastel1", etc.
# - min_link_value: Minimum connection value to display
# - chart.title.show: true/false (toggle title)
# - chart.title.text: Title text
# - layout.autosize: true/false (responsive sizing)
# - layout.height: Chart height in pixels
#
# Data Processing Flow:
# 
# CALLBACK (uc_5_1_callbacks.py):
# 1. Extract BioRemPP DataFrame from merged-result-store
# 2. Map column names flexibly (sample, compoundclass)
# 3. Clean data: strip whitespace, remove nulls/placeholders
# 4. Rename columns to standard names ('sample', 'compoundclass')
# 5. Pass to PlotService
#
# STRATEGY (ChordStrategy - Aggregation Mode):
# 1. Receives data with ['sample', 'compoundclass']
# 2. GroupBy source and target, count interactions
# 3. Filter by min_link_value
# 4. Calculate arc spans (proportional or uniform)
# 5. Create circle arc traces (colored segments)
# 6. Create chord traces (bezier curves between nodes)
# 7. Create label traces (positioned outside arcs)
# 8. Return combined figure
#
# Database Support:
# - BioRemPP: ✅ Contains 'sample' and 'compoundclass' columns
# - HADEG: ❌ Does NOT contain compound class data
# - KEGG: ❌ Does NOT contain compound class data
#
# Rendering Logic:
# - Lazy loading: Chart renders only when accordion opens
# - Single trigger: accordion activation
# - No auto-update on data change (manual refresh required)
#
# Visualization Details:
# - Circle arcs: Colored segments representing nodes
# - Arc size: Proportional to total connections (if enabled)
# - Chords: Bezier curves connecting sample to compound class
# - Chord width: Proportional to interaction count
# - Labels: Positioned outside circle arcs
# - Colors: Unique color per node (from colorscale)
# - Hover: Node name and total connections (arcs), source-target-value (chords)
#
# Column Mapping (Flexible):
# - sample: "sample", "Sample", "sample_id", "Sample_ID", "sampleID", "genome", "Genome"
# - compoundclass: "compoundclass", "Compound_Class", "compound_class", "CompoundClass", "chemical_class"

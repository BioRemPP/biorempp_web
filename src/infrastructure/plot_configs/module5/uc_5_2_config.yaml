# ============================================================================
# UC-5.2: Sample Similarity Based on Shared Chemical Profiles
# ============================================================================
# Description: Chord diagram showing sample similarity via shared compounds
# Module: module5
# Plot Type: Chord Diagram (Pairwise Mode)
# Rendering: On-demand (accordion activation)
# ============================================================================

# ============================================================================
# SECTION 1: Metadata (REQUIRED)
# ============================================================================
metadata:
  use_case_id: "UC-5.2"
  module: "module5"
  title: "Sample Similarity Based on Shared Chemical Profiles"
  description: >
    Visualizes the pairwise similarity between microbial samples based on
    their shared chemical interaction profiles. The chord diagram shows
    connections where the strength of the link between any two samples is
    quantified by the number of compounds they have in common. This helps
    identify functional guilds and organisms with analogous degradation
    capabilities.
  version: "1.0.0"
  author: "BioRemPP Development Team"
  created_date: "2025-12-02"
  tags:
    - "chord_diagram"
    - "sample_similarity"
    - "pairwise_comparison"
    - "functional_guilds"
    - "shared_compounds"
    - "biorempp"
  plot_type: "chord_diagram"
  scientific_context:
    domain: "Comparative Metabolomics and Functional Ecology"
    application: "Identifying functional guilds and samples with similar metabolic capabilities"
    interpretation: "Thicker chords indicate more shared compounds; samples with many connections are metabolic generalists"

# ============================================================================
# SECTION 2: Data Configuration (REQUIRED)
# ============================================================================
data:
  source: "biorempp-result-store"
  source_type: "store"
  
  required_columns:
    - "sample"
    - "compoundname"
  
  processing:
    steps:
      - name: "validate"
        enabled: true
        validator: "standard"
        description: "Validate required columns exist"

# ============================================================================
# SECTION 3: Visualization Configuration (REQUIRED)
# ============================================================================
visualization:
  strategy: "ChordStrategy"
  
  plotly:
    # Processing mode (pairwise similarity)
    mode: "pairwise"
    group_by_column: "sample"
    shared_column: "compoundname"
    
    # Filter configuration
    min_link_value: 2
    
    # Color configuration
    colorscale: "Set2"
    
    # Circle arcs configuration
    circle_arcs:
      enabled: true
      width: 20
      gap: 0.025
      radius: 1.0
      proportional: true
    
    # Labels configuration
    labels:
      enabled: true
      radius_offset: 1.18
      font:
        size: 11
        family: "Arial, sans-serif"
        color: "#2c3e50"
    
    # Chords configuration
    chords:
      anchor: "arc_midpoint"
    
    # Chart configuration
    chart:
      title:
        show: true
        text: "Sample Similarity Network (Shared Compounds)"
        font:
          size: 18
          family: "Arial, sans-serif"
          color: "#2c3e50"
    
    # Layout configuration
    layout:
      height: 950
      autosize: true
      template: "simple_white"
      margin:
        l: 90
        r: 90
        t: 110
        b: 90

# ============================================================================
# SECTION 4: Interactivity Configuration (REQUIRED)
# ============================================================================
interactivity:
  triggers:
    - component_id: "uc-5-2-accordion-group"
      property: "active_item"
      trigger_type: "accordion_activation"
      description: "Render chord diagram when accordion opens"
  
  outputs:
    - component_id: "uc-5-2-chart"
      property: "children"
      output_type: "dcc.Graph"
      description: "Sample similarity chord diagram"
  
  states:
    - component_id: "merged-result-store"
      property: "data"
      description: "Merged data from all databases"

# ============================================================================
# SECTION 5: Validation Configuration (REQUIRED)
# ============================================================================
validation:
  rules:
    - rule: "not_empty"
      message: "Input data cannot be empty"
    
    - rule: "required_columns"
      columns: ["sample", "compoundname"]
      message: "Data must contain 'sample' and 'compoundname' columns"
    
    - rule: "minimum_samples"
      min_count: 2
      message: "At least 2 samples required for pairwise similarity analysis"
    
    - rule: "minimum_compounds"
      min_count: 1
      message: "At least 1 compound required for similarity calculation"

# ============================================================================
# SECTION 6: Performance Configuration (REQUIRED)
# ============================================================================
performance:
  cache:
    enabled: true
    layers:
      - layer: "dataframe"
        ttl: 7200
        key_template: "uc_5_2_df_{data_hash}"
        description: "Cache sample-compound data"
      
      - layer: "graph"
        ttl: 3600
        key_template: "uc_5_2_chord_{data_hash}"
        description: "Cache generated chord diagram"
    
    invalidation:
      on_data_change: true
      on_config_change: true
  
  logging:
    enabled: true
    level: "INFO"
    log_cache_hits: true
    log_generation_time: true
  
  lazy_loading:
    enabled: true
    render_on_accordion: true

# ============================================================================
# SECTION 7: Error Handling (RECOMMENDED)
# ============================================================================
error_handling:
  validation_errors:
    missing_columns:
      action: "display_message"
      message: "Required columns missing: {columns}. Similarity analysis requires 'sample' and 'compoundname' columns."
    
    empty_dataframe:
      action: "display_placeholder"
      message: "No sample-compound data available. Please check BioRemPP dataset."
    
    insufficient_samples:
      action: "display_message"
      message: "At least 2 samples required for pairwise similarity. Found: {count}"
    
    no_shared_compounds:
      action: "display_placeholder"
      message: "No shared compounds found between samples. Cannot compute similarity."
    
    biorempp_data_missing:
      action: "display_message"
      message: "BioRemPP database data not found. This use case requires BioRemPP data."
  
  processing_errors:
    pairwise_calculation_failure:
      action: "log_and_notify"
      fallback: "display_error_message"
      message: "Failed to calculate pairwise similarity: {error_details}"
    
    plot_render_failure:
      action: "log_and_notify"
      fallback: "display_error_message"
      message: "Failed to render chord diagram: {error_details}"

# ============================================================================
# NOTES: Flexible Properties & Data Flow
# ============================================================================
# Flexible Properties (Configurable via YAML):
# - mode: "pairwise" (compute sample-sample similarity)
# - group_by_column: Column to group by (sample)
# - shared_column: Column to compute intersections (compoundname)
# - min_link_value: Minimum shared compounds to display link (1-10)
# - circle_arcs.enabled: true/false (toggle circle arcs)
# - circle_arcs.width: Arc thickness (5-30)
# - circle_arcs.gap: Space between arcs in radians (0.01-0.1)
# - circle_arcs.radius: Circle radius (0.8-1.2)
# - circle_arcs.proportional: true/false (size based on connections)
# - labels.enabled: true/false (toggle labels)
# - labels.radius_offset: Label distance from center (1.1-1.3)
# - labels.font: Font configuration
# - chords.anchor: "arc_midpoint" or "arc_start"
# - colorscale: "Pastel1", "Set2", "Category20", etc.
# - chart.title.show: true/false (toggle title)
# - chart.title.text: Title text
# - layout.autosize: true/false (responsive sizing)
# - layout.height: Chart height in pixels
#
# Data Processing Flow:
# 
# CALLBACK (uc_5_2_callbacks.py):
# 1. Extract BioRemPP DataFrame from merged-result-store
# 2. Map column names flexibly (sample, compoundname)
# 3. Clean data: strip whitespace, remove nulls/placeholders
# 4. Rename columns to standard names ('sample', 'compoundname')
# 5. Validate minimum 2 samples
# 6. Pass to PlotService
#
# STRATEGY (ChordStrategy - Pairwise Mode):
# 1. Receives data with ['sample', 'compoundname']
# 2. GroupBy 'sample', create sets of compounds per sample
# 3. Compute pairwise intersections (combinations of 2 samples)
# 4. Calculate intersection size (shared compounds count)
# 5. Filter by min_link_value
# 6. Calculate arc spans (proportional or uniform)
# 7. Create circle arc traces (colored segments)
# 8. Create chord traces (sample-sample connections)
# 9. Create label traces (sample names outside arcs)
# 10. Return combined figure
#
# Database Support:
# - BioRemPP: ✅ Contains 'sample' and 'compoundname' columns
# - HADEG: ❌ Does NOT contain compound name data
# - KEGG: ❌ Does NOT contain compound name data
#
# Rendering Logic:
# - Lazy loading: Chart renders only when accordion opens
# - Single trigger: accordion activation
# - No auto-update on data change (manual refresh required)
#
# Visualization Details:
# - Circle arcs: Colored segments representing samples
# - Arc size: Proportional to total connections (if enabled)
# - Chords: Bezier curves connecting similar samples
# - Chord width: Proportional to number of shared compounds
# - Labels: Sample names positioned outside circle arcs
# - Colors: Unique color per sample (from colorscale)
# - Hover: Sample name and total connections (arcs), sample pair and shared count (chords)
#
# Column Mapping (Flexible):
# - sample: "sample", "Sample", "sample_id", "Sample_ID", "sampleID", "genome", "Genome"
# - compoundname: "compoundname", "Compound_Name", "compound_name", "CompoundName", "compound", "Compound"
#
# Pairwise Calculation:
# - For each pair of samples (A, B):
#   * Compounds_A = set of compounds in sample A
#   * Compounds_B = set of compounds in sample B
#   * Shared = Compounds_A ∩ Compounds_B
#   * Link value = |Shared| (count of shared compounds)
# - Only pairs with shared compounds > min_link_value are displayed

# ============================================================================
# UC-5.6: Compound-Compound Functional Similarity Network
# ============================================================================
# Description: Similarity network where compounds are connected based on shared genes
# Module: module5
# Plot Type: Network (Similarity)
# Rendering: On-demand (accordion activation)
# ============================================================================

# ============================================================================
# SECTION 1: Metadata (REQUIRED)
# ============================================================================
metadata:
  use_case_id: "UC-5.6"
  module: "module5"
  title: "Compound-Compound Functional Similarity Network"
  description: >
    Similarity network where compounds are connected based on shared gene
    interactions. Edge weight represents the number of genes shared between
    two compounds. Reveals compound clusters with similar degradation pathways,
    hub compounds targeted by many genes, and compounds with overlapping
    genetic mechanisms. Enables identification of functionally related compounds
    and potential compound groups for bioremediation strategies.
  version: "1.0.0"
  author: "BioRemPP Development Team"
  created_date: "2025-12-03"
  tags:
    - "network"
    - "similarity"
    - "compound_compound"
    - "degradation_pathways"
    - "biorempp"
  plot_type: "network"
  scientific_context:
    domain: "Chemical Biology and Degradation Networks"
    application: "Compound similarity analysis based on gene interactions"
    interpretation: "Node color/size indicates connectivity; edge width shows similarity strength (shared genes)"

# ============================================================================
# SECTION 2: Data Configuration (REQUIRED)
# ============================================================================
data:
  source: "biorempp-result-store"
  source_type: "store"
  
  required_columns:
    - "compoundname"
    - "genesymbol"
  
  processing:
    steps:
      - name: "extract_biorempp"
        enabled: true
        description: "Extract BioRemPP results from store"
      
      - name: "map_compound_to_genes"
        enabled: true
        description: "Map each compound to its set of associated genes"
      
      - name: "compute_pairwise_similarity"
        enabled: true
        description: "Compute shared genes between compound pairs"
      
      - name: "build_similarity_network"
        enabled: true
        description: "Build network with weighted edges (edge weight = shared genes)"

# ============================================================================
# SECTION 3: Visualization Configuration (REQUIRED)
# ============================================================================
visualization:
  strategy: "NetworkStrategy"
  
  plotly:
    # Processing mode
    mode: "similarity"
    group_by_column: "compoundname"
    shared_column: "genesymbol"
    min_edge_weight: 1
    
    # Layout algorithm configuration
    layout_algorithm:
      algorithm: "spring"
      k: 0.5
      iterations: 50
      seed: 42
    
    # Node configuration
    node_size: 15
    colorscale: "YlGnBu"
    
    # Edge configuration
    edge_color: "rgba(136, 136, 136, 0.5)"
    
    # Chart configuration
    chart:
      title:
        show: true
        text: "Compound-Compound Functional Similarity Network"
        font:
          size: 16
      
      show_legend: false
    
    # Layout configuration
    layout:
      template: "simple_white"
      height: 900
      autosize: true
      
      plot_bgcolor: "white"
      paper_bgcolor: "white"
      
      margin:
        l: 20
        r: 20
        t: 60
        b: 20

# ============================================================================
# SECTION 4: Interactivity Configuration (REQUIRED)
# ============================================================================
interactivity:
  triggers:
    - component_id: "uc-5-6-accordion-group"
      property: "active_item"
      trigger_type: "accordion_open"
      description: "Render network when accordion opens"
  
  outputs:
    - component_id: "uc-5-6-chart"
      property: "children"
      output_type: "dcc.Graph"
      description: "Compound-compound similarity network"
  
  states:
    - component_id: "merged-result-store"
      property: "data"
      description: "Merged data from all databases"

# ============================================================================
# SECTION 5: Validation Configuration (REQUIRED)
# ============================================================================
validation:
  rules:
    - rule: "not_empty"
      message: "Input data cannot be empty"
    
    - rule: "required_columns"
      columns: ["compoundname", "genesymbol"]
      message: "Data must contain 'compoundname' and 'genesymbol' columns"
    
    - rule: "minimum_compounds"
      min_count: 2
      message: "At least 2 compounds required for similarity network"
    
    - rule: "biorempp_data_required"
      message: "This use case requires BioRemPP database"

# ============================================================================
# SECTION 6: Performance Configuration (REQUIRED)
# ============================================================================
performance:
  cache:
    enabled: true
    layers:
      - layer: "dataframe"
        ttl: 7200
        key_template: "uc_5_6_df_{data_hash}"
        description: "Cache processed similarity network data"
      
      - layer: "graph"
        ttl: 3600
        key_template: "uc_5_6_network_{data_hash}"
        description: "Cache generated similarity network"
    
    invalidation:
      on_data_change: true
      on_config_change: true
  
  logging:
    enabled: true
    level: "INFO"
    log_cache_hits: true
    log_generation_time: true
  
  lazy_loading:
    enabled: true
    render_on_accordion: true

# ============================================================================
# SECTION 7: Error Handling (RECOMMENDED)
# ============================================================================
error_handling:
  validation_errors:
    missing_columns:
      action: "display_message"
      message: "Required columns missing: {columns}. Network requires 'compoundname' and 'genesymbol' columns."
    
    empty_dataframe:
      action: "display_placeholder"
      message: "No compound-gene data available. Please check BioRemPP dataset."
    
    insufficient_compounds:
      action: "display_message"
      message: "At least 2 compounds required for similarity network. Found: {count}"
    
    no_similarities:
      action: "display_message"
      message: "No compound pairs with shared genes found. Try lowering min_edge_weight."
    
    biorempp_data_missing:
      action: "display_message"
      message: "BioRemPP database data not found. This use case requires BioRemPP data."
  
  processing_errors:
    similarity_calculation_failure:
      action: "log_and_notify"
      fallback: "display_error_message"
      message: "Failed to calculate compound similarities: {error_details}"
    
    network_build_failure:
      action: "log_and_notify"
      fallback: "display_error_message"
      message: "Failed to build similarity network: {error_details}"
    
    plot_render_failure:
      action: "log_and_notify"
      fallback: "display_error_message"
      message: "Failed to render network diagram: {error_details}"

# ============================================================================
# NOTES: Flexible Properties & Data Flow
# ============================================================================
# Flexible Properties (Configurable via YAML):
# - title.show: true/false (toggle title)
# - title.text: Title text
# - title.font.size: Title font size
# - autosize: true/false (responsive sizing)
# - mode: "similarity"
# - group_by_column: Column to group by (compounds)
# - shared_column: Column for computing similarity (genes)
# - min_edge_weight: Minimum shared elements for edge creation
# - layout_algorithm.algorithm: "spring", "circular", "kamada_kawai", "shell"
# - layout_algorithm.k: Spring layout parameter (larger = more spacing)
# - layout_algorithm.iterations: Spring layout iterations
# - layout_algorithm.seed: Random seed for reproducibility
# - node_size: Base node size
# - colorscale: Node colorscale (color by degree)
# - edge_color: Edge color (can include opacity)
# - show_legend: true/false (toggle legend, usually false for similarity)
# - template: "simple_white", "plotly", "plotly_dark", etc.
# - height: Chart height in pixels
# - width: Chart width (if autosize=false)
# - margin: {l, r, t, b} margins
# - plot_bgcolor: Plot background color
# - paper_bgcolor: Paper background color
#
# Data Processing Flow:
# 
# CALLBACK (uc_5_6_callbacks.py):
# 1. Extract BioRemPP DataFrame from merged-result-store
# 2. Map columns: compoundname, genesymbol
# 3. Clean data (remove nulls, duplicates)
# 4. Pass to PlotService
#
# STRATEGY (NetworkStrategy):
# 1. Receives data with ['compoundname', 'genesymbol']
# 2. Process data (similarity mode):
#    - Map each compound to set of genes
#    - Compute pairwise similarities (shared genes)
#    - Filter edges by min_edge_weight
#    - Build NetworkX graph
#    - Calculate layout (spring algorithm)
# 3. Create figure:
#    - Create edge traces (width proportional to weight)
#    - Create node traces (color by degree, size by degree)
#    - Apply layout configuration
# 4. Returns Plotly figure
#
# Database Support:
# - BioRemPP: ✅ Contains 'compoundname', 'genesymbol' columns
# - KEGG: ❌ Different structure
# - HADEG: ❌ Different structure
# - ToxCSM: ❌ Does NOT contain gene data
#
# Rendering Logic:
# - Chart rendering: On accordion open (on-demand)
# - Single trigger: accordion active_item change
# - Loading spinner shown during processing
#
# Visualization Details:
# - Plot type: Similarity network
# - Nodes: Compounds (single type)
# - Edges: Compound-compound similarity (weighted by shared genes)
# - Layout: Spring force-directed layout
# - Node size: Proportional to degree (number of connections)
# - Node color: Gradient by degree (Viridis colorscale)
# - Edge width: Proportional to weight (shared genes)
# - Edge opacity: Gradient by weight
# - Hover: Shows compound name and number of connections
# - Colorbar: Shows degree scale
# - Interpretation:
#   * Large/bright nodes: Hubs (highly connected compounds)
#   * Small/dark nodes: Peripheral compounds
#   * Thick edges: High similarity (many shared genes)
#   * Thin edges: Low similarity (few shared genes)
#   * Dense clusters: Compound groups with similar degradation pathways
#
# Similarity Algorithm:
# For each pair of compounds (C1, C2):
#   shared = COUNT(genes targeting both C1 and C2)
#   if shared >= min_edge_weight:
#     Create edge: C1 ↔ C2 (weight=shared)
#
# Example:
# Compound "Benzene" shares 3 genes with Compound "Toluene"
# → Edge weight = 3
# → Edge width proportional to 3
# Compound "Benzene" connected to 8 other compounds
# → Node degree = 8
# → Node color/size based on degree
#
# Scientific Interpretation:
# - Compound clusters: Groups with similar degradation pathways
# - Hub compounds: Compounds targeted by many genes
# - Pathway overlap: Compounds with shared genetic mechanisms
# - Specialization: Isolated compounds with unique degradation pathways
# - Use for: Pathway analysis, compound classification, bioremediation strategy
# - Optimization: Identify compounds with overlapping vs. unique degradation mechanisms
#
# Layout Algorithms:
# - spring: Force-directed (Fruchterman-Reingold) - balanced, general-purpose
#   * k=0.5: More spacing for clarity
#   * iterations=50: Faster convergence
# - circular: Nodes arranged in circle - symmetry, small networks
# - kamada_kawai: Energy minimization - aesthetic, clear structure
# - shell: Concentric shells - hierarchical networks
#
# Node Colorscale (Viridis):
# - Purple/Dark: Low degree (few connections)
# - Green/Yellow: Medium degree
# - Bright Yellow: High degree (many connections, hubs)
# - Perceptually uniform gradient
#
# Edge Weight Filtering:
# - min_edge_weight: Minimum shared genes required
# - Default: 1 (at least 1 shared gene)
# - Higher values: Sparser network, stronger similarities only
# - Lower values: Denser network, weaker similarities included
#
# Unique Features:
# - Similarity-based network (single node type)
# - Weighted edges (shared genes)
# - Degree-based node coloring (hub identification)
# - Edge width scaling (similarity strength)
# - Configurable similarity threshold (min_edge_weight)
# - Colorbar for degree interpretation
# - No legend (single node type)
# - Viridis colorscale (different from gene-gene network)

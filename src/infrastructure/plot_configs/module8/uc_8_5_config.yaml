# ============================================================================
# UC-8.5: KEGG Pathways Completeness Scorecard
# ============================================================================
# Description: Heatmap showing pathway completeness scores per sample-pathway pair
# Module: module8
# Plot Type: Heatmap (Scored)
# Rendering: On-demand (accordion activation)
# Data Source: KEGG database
# Visualization: Color-only (no text labels for cleaner visual pattern recognition)
# ============================================================================

# ============================================================================
# SECTION 1: Metadata (REQUIRED)
# ============================================================================
metadata:
  use_case_id: "UC-8.5"
  module: "module8"
  title: "KEGG Pathways Completeness Scorecard"
  description: >
    Heatmap scorecard showing KO completeness scores (0-100%) for each
    microbial sample across KEGG metabolic pathways. Uses color-only
    visualization (no text labels) to emphasize visual pattern recognition
    for identifying elite metabolic specialists and generalists.
  version: "1.0.0"
  author: "BioRemPP Development Team"
  created_date: "2025-12-01"
  tags:
    - "completeness_scorecard"
    - "heatmap"
    - "ko_completeness"
    - "kegg_pathways"
    - "metabolic_pathways"
  plot_type: "heatmap"
  scientific_context:
    domain: "Metabolic Pathway Genomics"
    application: "Elite metabolic specialist identification for KEGG pathways"
    interpretation: "Quantifies genetic toolkit completeness at metabolic pathway level"

# ============================================================================
# SECTION 2: Data Configuration (REQUIRED)
# ============================================================================
data:
  source: "kegg-result-store"
  source_type: "store"
  
  required_columns:
    - "Sample"
    - "KO"
    - "Pathway"
  
  processing:
    steps:
      - name: "extract_kegg"
        enabled: true
        description: "Extract KEGG results from store"
      
      - name: "validate"
        enabled: true
        validator: "standard"
        description: "Validate required columns exist"
      
      - name: "normalize_identifiers"
        enabled: true
        params:
          strip_whitespace: true
          convert_ko_uppercase: true
          remove_duplicates: true
          remove_empty: true
        description: "Normalize sample, KO, and pathway names"
      
      - name: "build_ko_sets"
        enabled: true
        description: "Build KO sets per sample and per KEGG pathway"
      
      - name: "calculate_completeness_scores"
        enabled: true
        params:
          scoring_mode: "ko_completeness"
        description: "Calculate KO completeness percentage for each sample-pathway pair"

# ============================================================================
# SECTION 3: Visualization Configuration (REQUIRED)
# ============================================================================
visualization:
  strategy: "HeatmapScoredStrategy"
  
  plotly:
    # Strategy-specific parameters
    scoring_mode: "ko_completeness"
    category_column: "Pathway"
    sample_column: "Sample"
    value_column: "KO"
    
    # Chart configuration
    chart:
      # Title configuration
      title:
        show: true
        text: "KEGG Pathways Completeness Scorecard"
        font:
          size: 16
          family: "Arial"
          color: "#2c3e50"
        x: 0.5
        xanchor: "center"
      
      # Axis configuration
      xaxis:
        title: "KEGG Pathway"
        title_font:
          size: 14
      
      yaxis:
        title: "Sample"
        title_font:
          size: 14
      
      # Color configuration
      color_label: "Pathway Completeness (%)"
      color_continuous_scale: "Greens"
      
      # Text display in cells (DISABLED for color-only visualization)
      show_values: false
      text_auto: false
      
      # Axis label angles
      xaxis_tickangle: -45
      yaxis_tickangle: 0
      
      # Colorbar configuration
      colorbar:
        title: "Pathway Completeness (%)"
        title_font:
          size: 12
    
    # Layout configuration
    layout:
      template: "simple_white"
      height: 800
      autosize: true
      margin:
        l: 80
        r: 100
        t: 100
        b: 120
      showlegend: false

# ============================================================================
# SECTION 4: Interactivity Configuration (REQUIRED)
# ============================================================================
interactivity:
  triggers:
    - component_id: "uc-8-5-accordion-group"
      property: "active_item"
      trigger_type: "accordion_open"
      description: "Render heatmap when accordion opens"
  
  outputs:
    - component_id: "uc-8-5-chart"
      property: "children"
      output_type: "dcc.Graph"
      description: "KEGG pathway completeness scorecard heatmap"
  
  states: []

# ============================================================================
# SECTION 5: Validation Configuration (REQUIRED)
# ============================================================================
validation:
  rules:
    - rule: "not_empty"
      message: "Input data cannot be empty"
    
    - rule: "required_columns"
      columns: ["Sample", "KO", "Pathway"]
      message: "Data must contain 'Sample', 'KO', and 'Pathway' columns for KEGG pathway completeness analysis"
    
    - rule: "minimum_samples"
      min_count: 1
      message: "At least 1 sample required for KEGG pathway completeness scorecard"
    
    - rule: "minimum_categories"
      min_count: 1
      message: "At least 1 KEGG pathway required for completeness scorecard"
    
    - rule: "no_nulls"
      columns: ["Sample", "KO", "Pathway"]
      message: "Null values not allowed in required columns"

# ============================================================================
# SECTION 6: Performance Configuration (REQUIRED)
# ============================================================================
performance:
  cache:
    enabled: true
    layers:
      - layer: "dataframe"
        ttl: 7200
        key_template: "uc_8_5_df_{data_hash}"
        description: "Cache KEGG pathway completeness score matrix"
      
      - layer: "graph"
        ttl: 3600
        key_template: "uc_8_5_heatmap_{data_hash}_{filters_hash}"
        description: "Cache generated heatmap"
    
    invalidation:
      on_data_change: true
      on_config_change: true
  
  logging:
    enabled: true
    level: "INFO"
    log_cache_hits: true
    log_generation_time: true
  
  lazy_loading: true
  render_on_accordion: true

# ============================================================================
# SECTION 7: Error Handling (RECOMMENDED)
# ============================================================================
error_handling:
  validation_errors:
    missing_columns:
      action: "display_message"
      message: "Required columns missing: {columns}. KEGG pathway completeness scorecard requires 'Sample', 'KO', and 'Pathway' columns."
    
    empty_dataframe:
      action: "display_placeholder"
      message: "No KEGG pathway completeness data available."
    
    insufficient_samples:
      action: "display_message"
      message: "At least 1 sample required for KEGG pathway completeness analysis. Found: {count}"
    
    insufficient_categories:
      action: "display_message"
      message: "At least 1 KEGG pathway required for completeness analysis. Found: {count}"
  
  processing_errors:
    set_construction_failure:
      action: "log_and_notify"
      fallback: "display_error_message"
      message: "Failed to build KO sets: {error_details}"
    
    score_calculation_failure:
      action: "log_and_notify"
      fallback: "display_error_message"
      message: "Failed to calculate KEGG pathway completeness scores: {error_details}"
    
    plot_render_failure:
      action: "log_and_notify"
      fallback: "display_error_message"
      message: "Failed to render KEGG pathway completeness heatmap: {error_details}"

# ============================================================================
# NOTES: Scoring Algorithm, Data Source & Visualization Design
# ============================================================================
# KEGG Pathway Completeness Scoring:
# 1. For each (Sample, KEGG_Pathway): count unique KOs
# 2. For each KEGG_Pathway: calculate total unique KOs (universe)
# 3. Completeness = (sample KOs / pathway KOs) × 100%
# 4. Matrix: samples (rows) × KEGG pathways (columns)
#
# Data Source:
# - KEGG database: Contains metabolic pathway annotations
# - Column naming: Sample and KO are UPPERCASE, Pathway is capitalized
#
# Visualization Design (Key Difference from UC-8.2):
# - UC-8.2: Shows text labels in cells (text_auto: ".1f")
# - UC-8.5: Uses color gradients only (text_auto: false)
# - Purpose: Rapid visual screening and pattern identification
# - Hover tooltips still provide exact numerical values when needed
# - Reduces visual clutter for large pathway matrices
#
# Interpretation:
# - Dark green cells (>80%): Elite metabolic specialists
# - Light green cells (<30%): Functional gaps requiring metabolic engineering
# - Row patterns: Assess sample metabolic breadth (generalists vs specialists)
# - Column patterns: Identify complex pathways needing consortia
#
# Integration:
# - Complements HADEG pathway completeness (UC-8.4)
# - Complements compound/class-level completeness (UC-8.2, UC-8.3)
# - Enables multi-layered reasoning for consortium design

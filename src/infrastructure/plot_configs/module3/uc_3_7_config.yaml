# ============================================================================
# UC-3.7: Compound Co-occurrence Patterns Across Samples
# ============================================================================
# Description: Correlogram showing compound-compound co-occurrence patterns based on sample presence
# Module: module3
# Plot Type: Correlogram (Correlation Heatmap - Feature Mode)
# Rendering: On-demand (accordion activation)
# ============================================================================

# ============================================================================
# SECTION 1: Metadata (REQUIRED)
# ============================================================================
metadata:
  use_case_id: "UC-3.7"
  module: "module3"
  title: "Compound Co-occurrence Patterns Across Samples"
  description: >
    Visualizes the pairwise co-occurrence relationships between chemical
    compounds across all microbial samples. A correlogram heatmap displays
    Pearson correlation coefficients indicating how frequently any two
    compounds are found together in the same samples. This analysis reveals
    compounds that might be part of the same degradation pathway, co-contaminants,
    or require similar enzymatic machinery for processing.
  version: "1.0.0"
  author: "BioRemPP Development Team"
  created_date: "2025-12-02"
  tags:
    - "correlogram"
    - "compound_cooccurrence"
    - "feature_correlation"
    - "degradation_pathways"
    - "biorempp"
  plot_type: "correlogram"
  scientific_context:
    domain: "Chemical Ecology and Metabolic Network Analysis"
    application: "Identifying compounds that co-occur across samples, suggesting shared degradation pathways"
    interpretation: "High correlation (red) indicates compounds frequently processed together; low correlation (blue) indicates independent or mutually exclusive processing"

# ============================================================================
# SECTION 2: Data Configuration (REQUIRED)
# ============================================================================
data:
  source: "biorempp-result-store"
  source_type: "store"
  
  required_columns:
    - "Sample"
    - "Compound_Name"
  
  processing:
    steps:
      - name: "validate"
        enabled: true
        validator: "standard"
        description: "Validate required columns exist"

# ============================================================================
# SECTION 3: Visualization Configuration (REQUIRED)
# ============================================================================
visualization:
  strategy: "CorrelogramStrategy"
  
  plotly:
    # Processing mode
    correlation_mode: "feature"
    row_column: "Sample"
    col_column: "Compound_Name"
    correlation_method: "pearson"
    
    # Chart configuration
    chart:
      # Title configuration
      title:
        show: true
        text: "Compound Co-occurrence Network"
        font_size: 18
      
      # Axis configuration
      xaxis_title: "Compound"
      yaxis_title: "Compound"
      xaxis_tickangle: -45
      yaxis_tickangle: 0
      
      # Color configuration
      color_continuous_scale: "RdBu_r"
      color_label: "Pearson r"
      
      # Cell value display
      text_auto: false
      
      # Colorbar configuration
      colorbar:
        title: "Co-occurrence"
        title_font_size: 12
    
    # Layout configuration
    layout:
      height: 750
      autosize: true
      template: "simple_white"
      margin:
        l: 140
        r: 50
        t: 90
        b: 140

# ============================================================================
# SECTION 4: Interactivity Configuration (REQUIRED)
# ============================================================================
interactivity:
  triggers:
    - component_id: "uc-3-7-accordion-group"
      property: "active_item"
      trigger_type: "accordion_activation"
      description: "Render correlogram when accordion opens"
  
  outputs:
    - component_id: "uc-3-7-chart"
      property: "children"
      output_type: "dcc.Graph"
      description: "Compound co-occurrence correlogram"
  
  states:
    - component_id: "merged-result-store"
      property: "data"
      description: "Merged data from all databases"

# ============================================================================
# SECTION 5: Validation Configuration (REQUIRED)
# ============================================================================
validation:
  rules:
    - rule: "not_empty"
      message: "Input data cannot be empty"
    
    - rule: "required_columns"
      columns: ["Sample", "Compound_Name"]
      message: "Data must contain 'Sample' and 'Compound_Name' columns"
    
    - rule: "minimum_compounds"
      min_count: 2
      message: "At least 2 compounds required for co-occurrence analysis"
    
    - rule: "biorempp_data_required"
      message: "This use case requires BioRemPP database"

# ============================================================================
# SECTION 6: Performance Configuration (REQUIRED)
# ============================================================================
performance:
  cache:
    enabled: true
    layers:
      - layer: "dataframe"
        ttl: 7200
        key_template: "uc_3_7_df_{data_hash}"
        description: "Cache correlation matrix"
      
      - layer: "graph"
        ttl: 3600
        key_template: "uc_3_7_corr_{data_hash}"
        description: "Cache generated correlogram"
    
    invalidation:
      on_data_change: true
      on_config_change: true
  
  logging:
    enabled: true
    level: "INFO"
    log_cache_hits: true
    log_generation_time: true
  
  lazy_loading:
    enabled: true
    render_on_accordion: true

# ============================================================================
# SECTION 7: Error Handling (RECOMMENDED)
# ============================================================================
error_handling:
  validation_errors:
    missing_columns:
      action: "display_message"
      message: "Required columns missing: {columns}. Compound co-occurrence analysis requires 'Sample' and 'Compound_Name' columns."
    
    empty_dataframe:
      action: "display_placeholder"
      message: "No sample-compound data available. Please check BioRemPP dataset."
    
    insufficient_compounds:
      action: "display_message"
      message: "At least 2 compounds required for co-occurrence. Found: {count}"
    
    biorempp_data_missing:
      action: "display_message"
      message: "BioRemPP database data not found. This use case requires BioRemPP data."
  
  processing_errors:
    correlation_failure:
      action: "log_and_notify"
      fallback: "display_error_message"
      message: "Failed to compute compound correlation: {error_details}"
    
    plot_render_failure:
      action: "log_and_notify"
      fallback: "display_error_message"
      message: "Failed to render correlogram: {error_details}"

# ============================================================================
# NOTES: Flexible Properties & Data Flow
# ============================================================================
# Flexible Properties (Configurable via YAML):
# - correlation_mode: "feature" (compound-compound correlation)
# - correlation_method: "pearson", "spearman", "kendall"
# - row_column: "Sample" (context for co-occurrence)
# - col_column: "Compound_Name" (entity to correlate)
# - chart.title.show: true/false (toggle title)
# - chart.title.text: Title text
# - chart.title.font_size: Title font size (12-24)
# - chart.xaxis_title: X-axis label
# - chart.yaxis_title: Y-axis label
# - chart.xaxis_tickangle: X-axis label rotation (-90 to 90)
# - chart.yaxis_tickangle: Y-axis label rotation (-90 to 90)
# - chart.color_continuous_scale: "RdBu_r", "Viridis", "Blues", etc.
# - chart.color_label: Colorbar label
# - chart.text_auto: true/false (show correlation values in cells)
# - chart.colorbar.title: Colorbar title
# - chart.colorbar.title_font_size: Colorbar font size
# - layout.autosize: true/false (responsive sizing)
# - layout.height: Chart height in pixels
# - layout.width: Chart width (if autosize=false)
# - layout.template: "simple_white", "plotly", "plotly_dark", etc.
# - layout.margin: {l, r, t, b} margins
#
# Data Processing Flow:
# 
# CALLBACK (uc_3_7_callbacks.py):
# 1. Extract BioRemPP DataFrame from merged-result-store
# 2. Map column names flexibly:
#    - Sample: "Sample", "sample", "sample_id", "Sample_ID", "sampleID", "genome", "Genome", "organism"
#    - Compound_Name: "Compound_Name", "compound_name", "compoundname", "CompoundName", "compound", "Compound", "chemical", "Chemical", "chemical_name"
# 3. Clean data:
#    a. Remove nulls
#    b. Strip whitespace
#    c. Remove empty strings
# 4. Rename columns to standard names ('Sample', 'Compound_Name')
# 5. Validate minimum 2 compounds
# 6. Pass to PlotService
#
# STRATEGY (CorrelogramStrategy - Feature Mode):
# 1. Receives data with ['Sample', 'Compound_Name']
# 2. Build presence/absence matrix:
#    - Rows: Samples
#    - Columns: Compound names
#    - Values: 1 (present) or 0 (absent)
# 3. Compute compound-compound correlation:
#    - Direct correlation of columns
#    - Result: Compound × Compound correlation matrix
# 4. Create heatmap:
#    - X-axis: Compound names
#    - Y-axis: Compound names
#    - Cell colors: Correlation values (-1 to +1)
#    - Diagonal: Always 1.0 (self-correlation)
# 5. Return Plotly figure
#
# Database Support:
# - BioRemPP: ✅ Contains 'Sample' and 'Compound_Name' columns
# - HADEG: ❌ Does NOT contain compound data
# - KEGG: ❌ Does NOT contain sample associations
# - ToxCSM: ❌ Does NOT contain sample data
#
# Rendering Logic:
# - Lazy loading: Chart renders only when accordion opens
# - Single trigger: accordion activation
# - No auto-update on data change (manual refresh required)
#
# Visualization Details:
# - Heatmap type: Symmetric correlation matrix
# - Color scale: RdBu_r (diverging)
#   * Red: Positive correlation (compounds co-occur frequently)
#   * White: No correlation (independent occurrence)
#   * Blue: Negative correlation (mutual exclusion)
# - Value range: -1 to +1 (Pearson r)
# - Diagonal: Always 1.0 (perfect self-correlation)
# - Hover: Compound pair and correlation value
# - Interpretation:
#   * r > 0.7: Strong co-occurrence (likely same degradation pathway)
#   * 0.3 < r < 0.7: Moderate co-occurrence
#   * r < 0.3: Weak or no co-occurrence
#   * r < 0: Mutual exclusion (compounds rarely processed together)
#
# Column Mapping (Flexible):
# - Sample: "Sample", "sample", "sample_id", "Sample_ID", "sampleID", "genome", "Genome", "organism"
# - Compound_Name: "Compound_Name", "compound_name", "compoundname", "CompoundName", "compound", "Compound", "chemical", "Chemical", "chemical_name"
#
# Correlation Computation:
# 1. Build binary matrix M (samples × compounds)
# 2. Compute correlation: corr(M) = Compound × Compound matrix
# 3. Each cell (i,j) = Pearson correlation between compound i and compound j
# 4. Based on co-occurrence patterns across samples
#
# Scientific Interpretation:
# - High correlation: Compounds frequently processed together → likely same degradation pathway, co-contaminants, or similar enzymatic requirements
# - Low correlation: Compounds processed independently → different metabolic pathways
# - Negative correlation: Compounds rarely co-occur → mutually exclusive pathways, competitive inhibition
# - Use for: Pathway discovery, identifying co-contaminants, understanding metabolic network structure
# - Comparison with UC-3.5: UC-3.5 correlates samples based on compounds; UC-3.7 correlates compounds based on samples
# - Comparison with UC-3.6: UC-3.6 correlates genes; UC-3.7 correlates chemical compounds

# ============================================================================
# UC-3.5: Sample Similarity Based on Chemical Profiles
# ============================================================================
# Description: Correlogram showing sample-sample similarity based on shared chemical compound profiles
# Module: module3
# Plot Type: Correlogram (Correlation Heatmap - Sample Mode)
# Rendering: On-demand (accordion activation)
# ============================================================================

# ============================================================================
# SECTION 1: Metadata (REQUIRED)
# ============================================================================
metadata:
  use_case_id: "UC-3.5"
  module: "module3"
  title: "Sample Similarity Based on Chemical Profiles"
  description: >
    Visualizes the pairwise similarity between microbial samples based on their
    shared chemical compound interaction profiles. A correlogram heatmap displays
    Pearson correlation coefficients, where higher values indicate samples with
    overlapping chemical degradation capabilities. This analysis reveals which
    samples have similar metabolic profiles in terms of compound processing.
  version: "1.0.0"
  author: "BioRemPP Development Team"
  created_date: "2025-12-02"
  tags:
    - "correlogram"
    - "sample_similarity"
    - "chemical_profiles"
    - "compound_interaction"
    - "biorempp"
  plot_type: "correlogram"
  scientific_context:
    domain: "Chemical Ecology and Metabolic Profiling"
    application: "Identifying samples with similar chemical degradation capabilities"
    interpretation: "High correlation (red) indicates samples with similar compound interaction profiles; low correlation (blue) indicates metabolic divergence"

# ============================================================================
# SECTION 2: Data Configuration (REQUIRED)
# ============================================================================
data:
  source: "biorempp-result-store"
  source_type: "store"
  
  required_columns:
    - "Sample"
    - "Compound_Name"
  
  processing:
    steps:
      - name: "validate"
        enabled: true
        validator: "standard"
        description: "Validate required columns exist"

# ============================================================================
# SECTION 3: Visualization Configuration (REQUIRED)
# ============================================================================
visualization:
  strategy: "CorrelogramStrategy"
  
  plotly:
    # Processing mode
    correlation_mode: "sample"
    row_column: "Sample"
    col_column: "Compound_Name"
    correlation_method: "pearson"
    
    # Chart configuration
    chart:
      # Title configuration
      title:
        show: true
        text: "Sample Chemical Similarity (Compound-based)"
        font_size: 18
      
      # Axis configuration
      xaxis_title: "Sample"
      yaxis_title: "Sample"
      xaxis_tickangle: -45
      yaxis_tickangle: 0
      
      # Color configuration
      color_continuous_scale: "RdBu_r"
      color_label: "Pearson r"
      
      # Cell value display
      text_auto: false
      
      # Colorbar configuration
      colorbar:
        title: "Correlation"
        title_font_size: 12
    
    # Layout configuration
    layout:
      height: 750
      autosize: true
      template: "simple_white"
      margin:
        l: 100
        r: 50
        t: 90
        b: 100

# ============================================================================
# SECTION 4: Interactivity Configuration (REQUIRED)
# ============================================================================
interactivity:
  triggers:
    - component_id: "uc-3-5-accordion-group"
      property: "active_item"
      trigger_type: "accordion_activation"
      description: "Render correlogram when accordion opens"
  
  outputs:
    - component_id: "uc-3-5-chart"
      property: "children"
      output_type: "dcc.Graph"
      description: "Sample chemical similarity correlogram"
  
  states:
    - component_id: "merged-result-store"
      property: "data"
      description: "Merged data from all databases"

# ============================================================================
# SECTION 5: Validation Configuration (REQUIRED)
# ============================================================================
validation:
  rules:
    - rule: "not_empty"
      message: "Input data cannot be empty"
    
    - rule: "required_columns"
      columns: ["Sample", "Compound_Name"]
      message: "Data must contain 'Sample' and 'Compound_Name' columns"
    
    - rule: "minimum_samples"
      min_count: 2
      message: "At least 2 samples required for correlation analysis"
    
    - rule: "biorempp_data_required"
      message: "This use case requires BioRemPP database"

# ============================================================================
# SECTION 6: Performance Configuration (REQUIRED)
# ============================================================================
performance:
  cache:
    enabled: true
    layers:
      - layer: "dataframe"
        ttl: 7200
        key_template: "uc_3_5_df_{data_hash}"
        description: "Cache correlation matrix"
      
      - layer: "graph"
        ttl: 3600
        key_template: "uc_3_5_corr_{data_hash}"
        description: "Cache generated correlogram"
    
    invalidation:
      on_data_change: true
      on_config_change: true
  
  logging:
    enabled: true
    level: "INFO"
    log_cache_hits: true
    log_generation_time: true
  
  lazy_loading:
    enabled: true
    render_on_accordion: true

# ============================================================================
# SECTION 7: Error Handling (RECOMMENDED)
# ============================================================================
error_handling:
  validation_errors:
    missing_columns:
      action: "display_message"
      message: "Required columns missing: {columns}. Chemical similarity analysis requires 'Sample' and 'Compound_Name' columns."
    
    empty_dataframe:
      action: "display_placeholder"
      message: "No sample-compound data available. Please check BioRemPP dataset."
    
    insufficient_samples:
      action: "display_message"
      message: "At least 2 samples required for correlation. Found: {count}"
    
    biorempp_data_missing:
      action: "display_message"
      message: "BioRemPP database data not found. This use case requires BioRemPP data."
  
  processing_errors:
    correlation_failure:
      action: "log_and_notify"
      fallback: "display_error_message"
      message: "Failed to compute sample correlation: {error_details}"
    
    plot_render_failure:
      action: "log_and_notify"
      fallback: "display_error_message"
      message: "Failed to render correlogram: {error_details}"

# ============================================================================
# NOTES: Flexible Properties & Data Flow
# ============================================================================
# Flexible Properties (Configurable via YAML):
# - correlation_mode: "sample" (sample-sample correlation)
# - correlation_method: "pearson", "spearman", "kendall"
# - row_column: "Sample" (entity to correlate)
# - col_column: "Compound_Name" (feature for comparison)
# - chart.title.show: true/false (toggle title)
# - chart.title.text: Title text
# - chart.title.font_size: Title font size (12-24)
# - chart.xaxis_title: X-axis label
# - chart.yaxis_title: Y-axis label
# - chart.xaxis_tickangle: X-axis label rotation (-90 to 90)
# - chart.yaxis_tickangle: Y-axis label rotation (-90 to 90)
# - chart.color_continuous_scale: "RdBu_r", "Viridis", "Blues", etc.
# - chart.color_label: Colorbar label
# - chart.text_auto: true/false (show correlation values in cells)
# - chart.colorbar.title: Colorbar title
# - chart.colorbar.title_font_size: Colorbar font size
# - layout.autosize: true/false (responsive sizing)
# - layout.height: Chart height in pixels
# - layout.width: Chart width (if autosize=false)
# - layout.template: "simple_white", "plotly", "plotly_dark", etc.
# - layout.margin: {l, r, t, b} margins
#
# Data Processing Flow:
# 
# CALLBACK (uc_3_5_callbacks.py):
# 1. Extract BioRemPP DataFrame from merged-result-store
# 2. Map column names flexibly:
#    - Sample: "Sample", "sample", "sample_id", "Sample_ID", "sampleID", "genome", "Genome", "organism"
#    - Compound_Name: "Compound_Name", "compound_name", "compoundname", "CompoundName", "compound", "Compound", "chemical", "Chemical", "chemical_name"
# 3. Clean data:
#    a. Remove nulls
#    b. Strip whitespace
#    c. Remove empty strings
# 4. Rename columns to standard names ('Sample', 'Compound_Name')
# 5. Validate minimum 2 samples
# 6. Pass to PlotService
#
# STRATEGY (CorrelogramStrategy - Sample Mode):
# 1. Receives data with ['Sample', 'Compound_Name']
# 2. Build presence/absence matrix:
#    - Rows: Samples
#    - Columns: Compound names
#    - Values: 1 (present) or 0 (absent)
# 3. Compute sample-sample correlation:
#    - Transpose matrix and correlate
#    - Result: Sample × Sample correlation matrix
# 4. Create heatmap:
#    - X-axis: Sample names
#    - Y-axis: Sample names
#    - Cell colors: Correlation values (-1 to +1)
#    - Diagonal: Always 1.0 (self-correlation)
# 5. Return Plotly figure
#
# Database Support:
# - BioRemPP: ✅ Contains 'Sample' and 'Compound_Name' columns
# - HADEG: ❌ Does NOT contain compound data
# - KEGG: ❌ Does NOT contain sample associations
# - ToxCSM: ❌ Does NOT contain sample data
#
# Rendering Logic:
# - Lazy loading: Chart renders only when accordion opens
# - Single trigger: accordion activation
# - No auto-update on data change (manual refresh required)
#
# Visualization Details:
# - Heatmap type: Symmetric correlation matrix
# - Color scale: RdBu_r (diverging)
#   * Red: Positive correlation (similar compound profiles)
#   * White: No correlation
#   * Blue: Negative correlation (dissimilar compound profiles)
# - Value range: -1 to +1 (Pearson r)
# - Diagonal: Always 1.0 (perfect self-correlation)
# - Hover: Sample pair and correlation value
# - Interpretation:
#   * r > 0.7: High similarity (shared chemical degradation capabilities)
#   * 0.3 < r < 0.7: Moderate similarity
#   * r < 0.3: Low similarity (divergent metabolic profiles)
#
# Column Mapping (Flexible):
# - Sample: "Sample", "sample", "sample_id", "Sample_ID", "sampleID", "genome", "Genome", "organism"
# - Compound_Name: "Compound_Name", "compound_name", "compoundname", "CompoundName", "compound", "Compound", "chemical", "Chemical", "chemical_name"
#
# Correlation Computation:
# 1. Build binary matrix M (samples × compounds)
# 2. Transpose: M^T (compounds × samples)
# 3. Compute correlation: corr(M^T) = Sample × Sample matrix
# 4. Each cell (i,j) = Pearson correlation between sample i and sample j
# 5. Based on shared compound presence/absence patterns
#
# Scientific Interpretation:
# - High correlation: Samples interact with many of the same compounds → similar metabolic capabilities
# - Low correlation: Samples have different compound sets → metabolic divergence
# - Use for: Sample clustering, identifying communities with similar degradation profiles
# - Comparison with UC-3.4: This uses compounds instead of KOs, revealing chemical (not functional) similarity

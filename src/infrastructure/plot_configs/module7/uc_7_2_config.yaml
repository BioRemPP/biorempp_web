# ============================================================================
# UC-7.2: Concordance Between Predicted Risk and Regulatory Focus
# ============================================================================
# Description: Chord diagram showing overlap between regulatory agencies and high-risk compounds
# Module: module7
# Plot Type: Chord Diagram (Set Intersection Mode - Cross-Database)
# Rendering: On-demand (dropdown selection)
# ============================================================================

# ============================================================================
# SECTION 1: Metadata (REQUIRED)
# ============================================================================
metadata:
  use_case_id: "UC-7.2"
  module: "module7"
  title: "Concordance Between Predicted Risk and Regulatory Focus"
  description: >
    Visualizes the overlap between compounds monitored by regulatory agencies
    and those predicted to be of high toxicological risk using a chord diagram.
    The connections represent the number of shared compounds between each pair
    of entities (agencies and high-risk category), revealing alignment or gaps
    between regulatory priorities and predicted toxicological concerns.
  version: "1.0.0"
  author: "BioRemPP Development Team"
  created_date: "2025-12-02"
  tags:
    - "chord_diagram"
    - "cross_database"
    - "risk_concordance"
    - "regulatory_alignment"
    - "biorempp"
    - "toxcsm"
  plot_type: "chord_diagram"
  scientific_context:
    domain: "Toxicology and Regulatory Compliance"
    application: "Assessing alignment between regulatory monitoring and predicted toxicological risk"
    interpretation: "Thicker chords indicate more shared compounds; reveals gaps between regulatory focus and predicted high-risk compounds"

# ============================================================================
# SECTION 2: Data Configuration (REQUIRED)
# ============================================================================
data:
  source: "cross-database"
  source_type: "store"
  databases:
    - "biorempp"
    - "toxcsm"
  
  required_columns:
    biorempp:
      - "referenceag"
      - "compoundname"
    toxcsm:
      - "compoundname"
      - "toxicity_score"
  
  processing:
    steps:
      - name: "validate"
        enabled: true
        validator: "standard"
        description: "Validate required columns exist in both databases"

# ============================================================================
# SECTION 3: Visualization Configuration (REQUIRED)
# ============================================================================
visualization:
  strategy: "ChordStrategy"
  
  plotly:
    # Processing mode (precomputed intersections from callback)
    # Callback computes set intersections and passes ['source', 'target', 'value']
    mode: "aggregation"
    source_column: "source"
    target_column: "target"
    value_column: "value"
    
    # Filter configuration
    min_link_value: 1
    
    # Color configuration
    colorscale: "Set3"
    
    # Circle arcs configuration
    circle_arcs:
      enabled: true
      width: 18
      gap: 0.03
      radius: 1.0
      proportional: true
    
    # Labels configuration
    labels:
      enabled: true
      radius_offset: 1.22
      font:
        size: 11
        family: "Arial, sans-serif"
        color: "#2c3e50"
    
    # Chords configuration
    chords:
      anchor: "arc_midpoint"
    
    # Chart configuration
    chart:
      title:
        show: true
        text: "Risk-Regulatory Concordance Network"
        font:
          size: 18
          family: "Arial, sans-serif"
          color: "#2c3e50"
    
    # Layout configuration
    layout:
      height: 950
      autosize: true
      template: "simple_white"
      margin:
        l: 90
        r: 90
        t: 110
        b: 90

# ============================================================================
# SECTION 4: Interactivity Configuration (REQUIRED)
# ============================================================================
interactivity:
  triggers:
    - component_id: "uc-7-2-threshold-dropdown"
      property: "value"
      trigger_type: "dropdown_selection"
      description: "Render chord diagram when threshold selected"
  
  outputs:
    - component_id: "uc-7-2-chart"
      property: "children"
      output_type: "dcc.Graph"
      description: "Risk-regulatory concordance chord diagram"
  
  states:
    - component_id: "merged-result-store"
      property: "data"
      description: "Merged data from all databases"
  
  controls:
    - type: "dropdown"
      id: "uc-7-2-threshold-dropdown"
      label: "Select Toxicity Threshold"
      options:
        - label: "High Risk (≥0.7)"
          value: 0.7
        - label: "Moderate Risk (≥0.5)"
          value: 0.5
        - label: "Low Risk (≥0.3)"
          value: 0.3
      default: 0.7
      clearable: false
      description: "Filter compounds by toxicity score threshold"

# ============================================================================
# SECTION 5: Validation Configuration (REQUIRED)
# ============================================================================
validation:
  rules:
    - rule: "not_empty"
      message: "Input data cannot be empty"
    
    - rule: "required_databases"
      databases: ["biorempp", "toxcsm"]
      message: "This use case requires both BioRemPP and ToxCSM databases"
    
    - rule: "required_columns"
      columns: ["source", "target", "value"]
      message: "Intersection data must contain 'source', 'target', and 'value' columns"
    
    - rule: "minimum_nodes"
      min_count: 2
      message: "At least 2 nodes required for chord diagram"
    
    - rule: "threshold_selected"
      message: "Please select a toxicity threshold from the dropdown"

# ============================================================================
# SECTION 6: Performance Configuration (REQUIRED)
# ============================================================================
performance:
  cache:
    enabled: true
    layers:
      - layer: "dataframe"
        ttl: 7200
        key_template: "uc_7_2_df_{data_hash}_{filters_hash}"
        description: "Cache intersection data per threshold"
      
      - layer: "graph"
        ttl: 3600
        key_template: "uc_7_2_chord_{data_hash}_{filters_hash}"
        description: "Cache generated chord diagram per threshold"
    
    invalidation:
      on_data_change: true
      on_config_change: true
      on_filter_change: true
  
  logging:
    enabled: true
    level: "INFO"
    log_cache_hits: true
    log_generation_time: true
  
  lazy_loading:
    enabled: true
    render_on_dropdown: true

# ============================================================================
# SECTION 7: Error Handling (RECOMMENDED)
# ============================================================================
error_handling:
  validation_errors:
    missing_databases:
      action: "display_message"
      message: "Required databases missing: {databases}. This use case requires both BioRemPP and ToxCSM data."
    
    missing_columns:
      action: "display_message"
      message: "Required columns missing: {columns}. Cross-database analysis requires specific columns from both databases."
    
    empty_dataframe:
      action: "display_placeholder"
      message: "No data available. Please check BioRemPP and ToxCSM datasets."
    
    no_threshold_selected:
      action: "display_prompt"
      message: "Please select a toxicity threshold from the dropdown above to visualize the chord diagram."
    
    no_high_risk_compounds:
      action: "display_message"
      message: "No compounds found with toxicity score ≥ {threshold}. Try a lower threshold."
    
    no_intersections:
      action: "display_message"
      message: "No overlapping compounds found between agencies and high-risk category."
  
  processing_errors:
    cross_database_failure:
      action: "log_and_notify"
      fallback: "display_error_message"
      message: "Failed to process cross-database analysis: {error_details}"
    
    intersection_calculation_failure:
      action: "log_and_notify"
      fallback: "display_error_message"
      message: "Failed to calculate set intersections: {error_details}"
    
    plot_render_failure:
      action: "log_and_notify"
      fallback: "display_error_message"
      message: "Failed to render chord diagram: {error_details}"

# ============================================================================
# NOTES: Flexible Properties & Data Flow
# ============================================================================
# Flexible Properties (Configurable via YAML):
# - mode: "aggregation" (uses precomputed intersections)
# - source_column: "source" (set name 1)
# - target_column: "target" (set name 2)
# - value_column: "value" (intersection size)
# - min_link_value: Minimum shared compounds to display (1-10)
# - circle_arcs.enabled: true/false (toggle circle arcs)
# - circle_arcs.width: Arc thickness (5-30)
# - circle_arcs.gap: Space between arcs in radians (0.01-0.1)
# - circle_arcs.radius: Circle radius (0.8-1.2)
# - circle_arcs.proportional: true/false (size based on connections)
# - labels.enabled: true/false (toggle labels)
# - labels.radius_offset: Label distance from center (1.1-1.3)
# - labels.font: Font configuration
# - chords.anchor: "arc_midpoint" or "arc_start"
# - colorscale: "Set3", "Set2", "Category20", etc.
# - chart.title.show: true/false (toggle title)
# - chart.title.text: Title text
# - layout.autosize: true/false (responsive sizing)
# - layout.height: Chart height in pixels
#
# Data Processing Flow:
# 
# CALLBACK (uc_7_2_callbacks.py):
# 1. Extract ToxCSM DataFrame
#    a. Map columns: compoundname, toxicity_score
#    b. Filter by threshold (e.g., ≥0.7) ← THRESHOLD APPLIED HERE
#    c. Create "High Predicted Risk" set
# 2. Extract BioRemPP DataFrame
#    a. Map columns: referenceag, compoundname
#    b. GroupBy agency, create compound sets
# 3. Combine all sets (agencies + "High Predicted Risk")
# 4. Compute pairwise intersections (combinations of 2)
# 5. Create DataFrame with ['source', 'target', 'value']
# 6. Pass to PlotService with filters={"threshold": value} (for cache key only)
#
# STRATEGY (ChordStrategy - Aggregation Mode):
# 1. Receives data with ['source', 'target', 'value'] (already filtered)
# 2. Uses precomputed values (no further aggregation needed)
# 3. Filter by min_link_value
# 4. Calculate arc spans (proportional or uniform)
# 5. Create circle arc traces (colored segments)
# 6. Create chord traces (set-set connections)
# 7. Create label traces (positioned outside arcs)
# 8. Return combined figure
# 
# NOTE: Threshold is NOT used by the strategy - it's only for cache differentiation.
# The callback pre-filters compounds by threshold before computing intersections.
#
# Database Support:
# - BioRemPP: ✅ Contains 'referenceAG' and 'compoundname'
# - ToxCSM: ✅ Contains 'compoundname' and 'toxicity_score'
# - HADEG: ❌ Not used in this analysis
# - KEGG: ❌ Not used in this analysis
#
# Rendering Logic:
# - Lazy loading: Chart renders only when threshold selected
# - Single trigger: dropdown selection
# - Cross-database processing in callback
# - No auto-update on data change (manual refresh required)
#
# Visualization Details:
# - Circle arcs: Colored segments representing agencies and "High Predicted Risk"
# - Arc size: Proportional to total connections (if enabled)
# - Chords: Bezier curves connecting sets with shared compounds
# - Chord width: Proportional to intersection size (shared compounds count)
# - Labels: Agency names and "High Predicted Risk" outside circle arcs
# - Colors: Unique color per node (from colorscale)
# - Hover: Node name and total connections (arcs), set pair and shared count (chords)
#
# Column Mapping (Flexible):
# BioRemPP:
# - referenceag: "referenceAG", "referenceag", "ReferenceAG", "reference_ag", "Agency", "agency"
# - compoundname: "compoundname", "Compound_Name", "compound_name", "CompoundName", "compound", "Compound"
# ToxCSM:
# - compoundname: "compoundname", "Compound_Name", "compound_name", "CompoundName", "compound", "Compound"
# - toxicity_score: "toxicity_score", "ToxicityScore", "score", "Score"
#
# Set Intersection Calculation:
# - For each pair of sets (Agency A, Agency B) or (Agency, High Risk):
#   * Compounds_A = set of compounds in set A
#   * Compounds_B = set of compounds in set B
#   * Shared = Compounds_A ∩ Compounds_B
#   * Link value = |Shared| (count of shared compounds)
# - Only pairs with shared compounds > min_link_value are displayed
#
# Threshold Options:
# - High Risk (≥0.7): Compounds with high predicted toxicity
# - Moderate Risk (≥0.5): Compounds with moderate predicted toxicity
# - Low Risk (≥0.3): Compounds with low predicted toxicity

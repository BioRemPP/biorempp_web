# ============================================================================
# UC-7.6: Sample Risk Mitigation Breadth by Compound Variety
# ============================================================================
# Description: Treemap showing sample risk mitigation breadth
# Module: module7
# Plot Type: Treemap (Hierarchical)
# Rendering: On-demand (accordion activation)
# ============================================================================

# ============================================================================
# SECTION 1: Metadata (REQUIRED)
# ============================================================================
metadata:
  use_case_id: "UC-7.6"
  module: "module7"
  title: "Sample Risk Mitigation Breadth by Compound Variety"
  description: >
    Hierarchical treemap visualizing which microbial samples possess the
    broadest capability to mitigate risk, measured by the variety of distinct
    high-risk compounds they can target within each toxicological category.
    Shows the nested relationship between samples and toxicity categories.
    Enables identification of versatile samples, risk mitigation breadth,
    and toxicity category coverage.
  version: "1.0.0"
  author: "BioRemPP Development Team"
  created_date: "2025-12-03"
  tags:
    - "treemap"
    - "hierarchical"
    - "toxicity"
    - "sample"
    - "toxcsm"
  plot_type: "treemap"
  scientific_context:
    domain: "Toxicology and Risk Assessment"
    application: "Sample risk mitigation breadth analysis"
    interpretation: "Rectangle size indicates risk mitigation capability; nesting shows hierarchy"

# ============================================================================
# SECTION 2: Data Configuration (REQUIRED)
# ============================================================================
data:
  source: "merged-result-store"
  source_type: "store"
  
  required_columns:
    - "Sample"
    - "Toxicity Category"
    - "unique_compound_count"
  
  processing:
    steps:
      - name: "extract_biorempp"
        enabled: true
        description: "Extract BioRemPP results (sample-compound links)"
      
      - name: "extract_toxcsm"
        enabled: true
        description: "Extract ToxCSM results (toxicity predictions)"
      
      - name: "merge_datasets"
        enabled: true
        description: "Merge BioRemPP and ToxCSM on compound name"
      
      - name: "filter_high_risk"
        enabled: true
        description: "Filter for high-risk compounds (toxicity_score > 0.5)"
      
      - name: "aggregate_values"
        enabled: true
        description: "Count unique compounds per sample per toxicity category"

# ============================================================================
# SECTION 3: Visualization Configuration (REQUIRED)
# ============================================================================
visualization:
  strategy: "TreemapStrategy"
  
  plotly:
    # Hierarchy configuration
    path_columns:
      - "Sample"
      - "Toxicity Category"
    
    root_label: "All Samples"
    
    # Aggregation configuration
    value_column: "unique_compound_count"
    aggregation: "sum"
    
    # Color configuration
    # Mode: "discrete" (categorical) or "continuous" (gradient)
    color_mode: "discrete"
    color_column: "Toxicity Category"
    
    # Discrete color palettes (choose one):
    # - Pastel1, Pastel2, Set1, Set2, Set3 (qualitative)
    # - Plotly, D3, G10, T10, Alphabet (qualitative)
    # - Safe, Vivid, Bold, Antique, Prism (qualitative)
    color_discrete_sequence: "Pastel1"
    
    # Alternative: Continuous color scale (if color_mode: "continuous")
    # color_continuous_scale: "Greens"
    # Options: Greens, Blues, Reds, YlOrRd, YlGnBu, RdYlGn, Viridis, Plasma, Inferno, Magma, Cividis
    
    # Chart configuration
    chart:
      title:
        show: true
        text: "Sample Risk Mitigation Breadth by Compound Variety"
        x: 0.5
        font:
          size: 16
      
      # Text configuration
      text_info: "label+value"
      text_font_size: 14
    
    # Layout configuration
    layout:
      template: "simple_white"
      height: 700
      autosize: true
      
      margin:
        t: 50
        l: 10
        r: 10
        b: 10

# ============================================================================
# SECTION 4: Interactivity Configuration (REQUIRED)
# ============================================================================
interactivity:
  triggers:
    - component_id: "uc-7-6-accordion-group"
      property: "active_item"
      trigger_type: "accordion_open"
      description: "Render treemap when accordion opens"
  
  outputs:
    - component_id: "uc-7-6-chart"
      property: "children"
      output_type: "dcc.Graph"
      description: "Hierarchical treemap"
  
  states:
    - component_id: "merged-result-store"
      property: "data"
      description: "Merged data from all databases"

# ============================================================================
# SECTION 5: Validation Configuration (REQUIRED)
# ============================================================================
validation:
  rules:
    - rule: "not_empty"
      message: "Input data cannot be empty"
    
    - rule: "required_columns"
      columns: ["Sample", "Toxicity Category", "unique_compound_count"]
      message: "Data must contain 'Sample', 'Toxicity Category', and 'unique_compound_count' columns"
    
    - rule: "min_hierarchy_levels"
      min_count: 2
      message: "At least 2 hierarchy levels required for treemap"
    
    - rule: "biorempp_toxcsm_data_required"
      message: "This use case requires both BioRemPP and ToxCSM databases"

# ============================================================================
# SECTION 6: Performance Configuration (REQUIRED)
# ============================================================================
performance:
  cache:
    enabled: true
    layers:
      - layer: "dataframe"
        ttl: 7200
        key_template: "uc_7_6_df_{data_hash}"
        description: "Cache processed hierarchy data"
      
      - layer: "graph"
        ttl: 3600
        key_template: "uc_7_6_treemap_{data_hash}"
        description: "Cache generated treemap"
    
    invalidation:
      on_data_change: true
      on_config_change: true
  
  logging:
    enabled: true
    level: "INFO"
    log_cache_hits: true
    log_generation_time: true
  
  lazy_loading:
    enabled: true
    render_on_accordion: true

# ============================================================================
# SECTION 7: Error Handling (RECOMMENDED)
# ============================================================================
error_handling:
  validation_errors:
    missing_columns:
      action: "display_message"
      message: "Required columns missing: {columns}. Treemap requires 'Sample', 'Toxicity Category', and 'unique_compound_count' columns."
    
    empty_dataframe:
      action: "display_placeholder"
      message: "No hierarchy data available. Please check BioRemPP and ToxCSM datasets."
    
    insufficient_levels:
      action: "display_message"
      message: "At least 2 hierarchy levels required for treemap. Found: {count}"
    
    biorempp_data_missing:
      action: "display_message"
      message: "BioRemPP database data not found. This use case requires BioRemPP data."
    
    toxcsm_data_missing:
      action: "display_message"
      message: "ToxCSM database data not found. This use case requires ToxCSM data."
  
  processing_errors:
    merge_failure:
      action: "log_and_notify"
      fallback: "display_error_message"
      message: "Failed to merge BioRemPP and ToxCSM data: {error_details}"
    
    hierarchy_build_failure:
      action: "log_and_notify"
      fallback: "display_error_message"
      message: "Failed to build hierarchy: {error_details}"
    
    aggregation_failure:
      action: "log_and_notify"
      fallback: "display_error_message"
      message: "Failed to aggregate values: {error_details}"
    
    plot_render_failure:
      action: "log_and_notify"
      fallback: "display_error_message"
      message: "Failed to render treemap: {error_details}"

# ============================================================================
# NOTES: Flexible Properties & Data Flow
# ============================================================================
# Data Processing (in callback):
# 1. Extract BioRemPP DataFrame (Sample, Compound_Name)
# 2. Extract ToxCSM DataFrame (compoundname, super_category, toxicity_score)
# 3. Filter ToxCSM for high-risk (toxicity_score > 0.5)
# 4. Merge on compound name
# 5. Aggregate: count unique compounds per Sample per Toxicity Category
# 6. Pass aggregated data to TreemapStrategy
#
# Columns After Processing:
# - Sample: Sample identifier
# - Toxicity Category: super_category from ToxCSM
# - unique_compound_count: Number of unique high-risk compounds
#
# Hierarchy (2 levels):
# All Samples (root)
#   ├─ Sample1
#   │   ├─ Hepatotoxicity (Toxicity Category) → 5 unique compounds
#   │   └─ Carcinogenicity (Toxicity Category) → 3 unique compounds
#   └─ Sample2
#       └─ Hepatotoxicity (Toxicity Category) → 7 unique compounds
#
# Scientific Interpretation:
# - Risk mitigation breadth: Number of unique high-risk compounds per sample
# - Toxicity category coverage: Which categories are covered by each sample
# - Versatile samples: Samples with high compound counts across categories
# - Specialized samples: Samples focused on specific toxicity categories
# - Use for: Sample selection, risk assessment, mitigation strategy planning
# - Optimization: Identify samples with broad risk mitigation capabilities
